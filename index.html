<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ìš´ì„¸ ì¶”ì²œ ì„œë¹„ìŠ¤ â€” ìµœì¢… í†µí•©íŒ (ê³ ê¸‰ ëª…ë¦¬í•™ ë¡œì§ ì•ˆì •í™”)</title>
<style>
  :root{
    --bg:#fbfbfc; --card:#fff; --accent:#d97706; --muted:#666;
    --high:#16a34a; --mid:#f59e0b; --low:#6b7280; --def:#9ca3af;
  }
  html,body{height:100%;margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;background:var(--bg);color:#111}
  .wrap{max-width:820px;margin:0 auto;padding:20px;}
  header{display:flex;justify-content:space-between;align-items:center}
  h1{margin:0;color:var(--accent);font-size:20px}
  p.desc{color:var(--muted);margin:8px 0 12px}
  label{display:block;margin-top:12px;font-weight:700}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  input[type="date"], select, input[type="text"], button{padding:10px;border-radius:6px;border:1px solid #ccc;font-size:16px;box-sizing:border-box}
  button{cursor:pointer;background:var(--accent);color:#fff;border:none;font-weight:700;transition:background .2s}
  button:hover{background:#b45309}
  .small{padding:6px 10px;font-size:12px;border-radius:4px}
  .card{background:var(--card);border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.08);padding:16px;margin-top:20px}
  .card .title{font-size:18px;font-weight:700;color:var(--accent);border-bottom:1px solid #eee;padding-bottom:8px;margin-bottom:12px}
  #pillars{margin-top:16px;padding:12px;border:1px dashed #ddd;border-radius:8px}
  .pillar-row{display:flex;justify-content:space-around;text-align:center}
  .pillar-cell{flex:1;padding:0 8px}
  .pillar-label{font-size:12px;color:var(--muted);margin-bottom:4px}
  .pillar-tg{font-size:24px;font-weight:700;color:#333}
  .pillar-dz{font-size:18px;color:var(--accent);margin-top:2px}
  #results{margin-top:20px}
  .single-result{display:flex;justify-content:space-between;align-items:flex-start;padding:12px 0;border-bottom:1px solid #eee}
  .single-result:last-child{border-bottom:none}
  .single-result .title{font-size:16px;font-weight:700}
  .single-result .right-fixed{display:flex;flex-direction:column;align-items:flex-end;gap:8px;margin-left:15px}
  .score-box{width:40px;height:40px;display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:900;color:#fff;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,.1)}
  .actions{display:flex;gap:4px}
  .badge{display:inline-block;padding:2px 6px;border-radius:4px;font-size:12px;margin-left:8px;font-weight:600}
  .cat-buttons{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
  .cat-buttons button{background:#eee;color:#333;border:1px solid #ccc;font-weight:600;padding:8px 12px}
  .cat-buttons button.active{background:var(--accent);color:#fff;border-color:var(--accent)}
  #lottoTimeDisplay div{font-size:14px;margin-top:4px}
  #savedList{margin-top:10px;padding:8px;border:1px solid #eee;border-radius:8px;}
  @media (max-width: 600px) {
    .row{flex-direction:column;gap:12px}
    input[type="date"], select, input[type="text"], button{width:100%}
    .pillar-row{justify-content:space-around}
  }
</style>
</head>
<body>

<div class="wrap">
  <header>
    <h1>ìš´ì„¸ ë¹„ì„œ</h1>
    <p class="desc">ì‚¬ì£¼ ê¸°ë°˜ ì›”ë³„/ì¼ë³„ ì¶”ì²œ</p>
  </header>
  
  <div class="card">
    <div class="title">ì‚¬ìš©ì ì‚¬ì£¼ ì…ë ¥ (ê¸°ì¤€)</div>
    <label>ìƒë…„ì›”ì¼ (ì–‘ë ¥)</label>
    <div class="row">
      <select id="birthYear"></select>
      <select id="birthMonth"></select>
      <select id="birthDay"></select>
    </div>
    <label>ì¶œìƒì‹œ / ì„±ë³„</label>
    <div class="row">
      <select id="birthhour">
        <option value="">ì‹œ ì„ íƒ ì•ˆí•¨ (ì¼ì£¼ë§Œ)</option>
        <option value="0">ìì‹œ (23:30 ~ 01:29)</option>
        <option value="2">ì¶•ì‹œ (01:30 ~ 03:29)</option>
        <option value="4">ì¸ì‹œ (03:30 ~ 05:29)</option>
        <option value="6">ë¬˜ì‹œ (05:30 ~ 07:29)</option>
        <option value="8">ì§„ì‹œ (07:30 ~ 09:29)</option>
        <option value="10">ì‚¬ì‹œ (09:30 ~ 11:29)</option>
        <option value="12">ì˜¤ì‹œ (11:30 ~ 13:29)</option>
        <option value="14">ë¯¸ì‹œ (13:30 ~ 15:29)</option>
        <option value="16">ì‹ ì‹œ (15:30 ~ 17:29)</option>
        <option value="18">ìœ ì‹œ (17:30 ~ 19:29)</option>
        <option value="20">ìˆ ì‹œ (19:30 ~ 21:29)</option>
        <option value="22">í•´ì‹œ (21:30 ~ 23:29)</option>
      </select>
      <select id="gender">
        <option value="male">ë‚¨ì„±</option>
        <option value="female">ì—¬ì„±</option>
      </select>
    </div>
    <label for="emailInput" style="margin-top:12px; font-weight:700;">
    ğŸ”’ ìœ ë£Œ ì„œë¹„ìŠ¤ ì¸ì¦ìš© ì´ë©”ì¼ ì£¼ì†Œ
    </label>
    <input type="email" id="emailInput" placeholder="ê²°ì œ ì‹œ ì‚¬ìš©í•œ ì´ë©”ì¼ ì…ë ¥" required 
       style="width: 100%; padding: 10px; margin-bottom: 15px; box-sizing: border-box;">
    
    <div id="pillars">ë§Œì„¸ë ¥ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
  </div>
  
  <div class="card">
    <div class="title">ìš´ì„¸ ì¡°íšŒ</div>
    <div class="row" style="align-items:flex-end;">
      <div style="flex:1;">
        <label>ì¡°íšŒ ì—°/ì›”</label>
        <div class="row" style="gap:4px">
          <select id="queryYear"></select>
          <select id="queryMonth"></select>
        </div>
      </div>
      <button id="monthTopBtn" style="flex:0;">í•œë‹¬ ì „ì²´ ì¶”ì²œ ë³´ê¸°</button>
      <select id="topN" style="width:70px;flex:0;">
        <option value="3">Top 3</option>
        <option value="5" selected>Top 5</option>
        <option value="7">Top 7</option>
      </select>
    </div>

    <div style="margin-top:16px;">
      <label>ë‹¨ì¼ ë‚ ì§œ í™•ì¸</label>
      <div class="row" style="gap:4px">
        <input type="date" id="queryDate" style="flex:1;">
        <button id="todayBtn" class="small">ì˜¤ëŠ˜</button>
        <button id="checkDateBtn">ë‚ ì§œ í™•ì¸</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="title">ì¡°íšŒ ê²°ê³¼</div>
    <div class="cat-buttons">
      <button data-cat="all" class="active">ì „ì²´</button>
      <button data-cat="wealth">ì¬ë¬¼</button>
      <button data-cat="match">ì¸ì—°</button>
      <button data-cat="business">ì‚¬ì—…</button>
      <button data-cat="travel">ì—¬í–‰</button>
      <button data-cat="move">ì´ì‚¬</button>
    </div>
    <div id="results"></div>
  </div>
  
  <div class="card">
    <div class="title">ì €ì¥ëœ ì¶”ì²œ ëª©ë¡</div>
    <div id="savedList"></div>
    <div style="margin-top:12px;display:flex;gap:8px;">
        <button class="small" onclick="if(!localDev){ alert('ë°°í¬ëª¨ë“œ ì¸ì¦ í•„ìš”'); return; } saveSaved([]); alert('ì €ì¥ ëª©ë¡ ì´ˆê¸°í™” ì™„ë£Œ');">ëª©ë¡ ì´ˆê¸°í™”</button>
        <button class="small" onclick="if(!localDev){ alert('ë°°í¬ëª¨ë“œ ì¸ì¦ í•„ìš”'); return; } localDev=!localDev; alert(localDev ? 'ê°œë°œ ëª¨ë“œ í™œì„±í™”' : 'ë°°í¬ ëª¨ë“œ í™œì„±í™”');" style="background:#555;">ëª¨ë“œ ì „í™˜</button>
    </div>
  </div>

</div>

<script>
// index.htmlì˜ <script> íƒœê·¸ ì•ˆì˜ ìµœì¢… ë‚´ìš©

// ----------------------------------------------------------------------
// [ë„ì›€ í•¨ìˆ˜] ì…ë ¥ì°½ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
// ----------------------------------------------------------------------
function getBirthInfo() { 
    return { 
        year: document.getElementById('birthYear').value, 
        month: document.getElementById('birthMonth').value, 
        day: document.getElementById('birthDay').value,
        hour: document.getElementById('birthhour').value,
        gender: document.getElementById('gender').value 
    };
}


// ----------------------------------------------------------------------
// [í•µì‹¬ í•¨ìˆ˜] ìƒë…„ì›”ì¼ ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°
// ----------------------------------------------------------------------
function initBirthSelectors() {
    // ì‚¬ì¥ë‹˜ì´ ì œê³µí•´ì£¼ì‹  ì •í™•í•œ ë“œë¡­ë‹¤ìš´ ìƒì„± ë¡œì§
    const y=document.getElementById('birthYear'), m=document.getElementById('birthMonth'), d=document.getElementById('birthDay');
    const now=new Date();
    
    // ì´ì „ì— ìƒì„±ëœ ì˜µì…˜ì´ ìˆë‹¤ë©´ ì œê±° (ì¤‘ë³µ ë°©ì§€)
    y.innerHTML = ''; m.innerHTML = ''; d.innerHTML = ''; 

    for(let yy=now.getFullYear()-80; yy<=now.getFullYear(); yy++){Â 
    Â  Â  const o=document.createElement('option'); o.value=yy; o.textContent=`${yy}ë…„`; y.appendChild(o);Â 
    }
    y.value = now.getFullYear() - 30; // ê¸°ë³¸ê°’ ì„¤ì • 
    
    for(let mm=1; mm<=12; mm++){ const o=document.createElement('option'); o.value=mm; o.textContent=`${mm}ì›”`; m.appendChild(o); }
    for(let dd=1; dd<=31; dd++){ const o=document.createElement('option'); o.value=dd; o.textContent=`${dd}ì¼`; d.appendChild(o); }
    
    // ì‚¬ì£¼ ê¸°ë‘¥ í‘œì‹œ í•¨ìˆ˜ëŠ” ì„œë²„ë¡œ ì˜®ê²¼ìœ¼ë¯€ë¡œ, displayPillars í•¨ìˆ˜ëŠ” ì—¬ê¸°ì„œ ì‚­ì œí•©ë‹ˆë‹¤.
    // [y, m, d, document.getElementById('birthhour'), document.getElementById('gender')].forEach(el => {
    // Â  el.addEventListener('change', displayPillars); // ì´ ì¤„ ì‚­ì œ
    // });
    // setTimeout(displayPillars, 100); // ì´ ì¤„ ì‚­ì œ
}


// ----------------------------------------------------------------------
// [í˜¸ì¶œ í•¨ìˆ˜] í˜ì´ì§€ ë¡œë“œ ì‹œ ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸° ë° ë²„íŠ¼ ì´ë²¤íŠ¸ ë“±ë¡
// ----------------------------------------------------------------------
document.addEventListener('DOMContentLoaded', function() {
    // 1. ë“œë¡­ë‹¤ìš´ ëª©ë¡ ì±„ìš°ê¸°
    initBirthSelectors(); 
    
    // 2. ê¸°ë³¸ê°’ ì„¤ì • (í•„ìš”í•˜ë‹¤ë©´)
    const now = new Date();
    document.getElementById('birthMonth').value = now.getMonth() + 1;
    document.getElementById('birthDay').value = now.getDate();

    // 3. ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ (ì„œë²„ í˜¸ì¶œ ë¡œì§)
    // -----------------------------------------------------------
    // (ì—¬ê¸°ì— Step 1-6ì—ì„œ ì‚¬ìš©í–ˆë˜ todayBtn, monthTopBtn ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì½”ë“œ ì „ì²´ë¥¼ ë‹¤ì‹œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”)
    // -----------------------------------------------------------
});

// index.htmlì˜ <script> íƒœê·¸ ì•ˆ (ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ëª¨ë‘ ì‚­ì œí•˜ê³  ì´ ì½”ë“œë¡œ ëŒ€ì²´)

// ----------------------------------------------------------------------
// [ë„ì›€ í•¨ìˆ˜] ì…ë ¥ì°½ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
// ----------------------------------------------------------------------
function getBirthInfo() {
    return { 
        year: document.getElementById('birthYear').value, 
        month: document.getElementById('birthMonth').value, 
        day: document.getElementById('birthDay').value,
        hour: document.getElementById('birthhour').value,
        gender: document.getElementById('gender').value 
    };
}

// ----------------------------------------------------------------------
// 1. ì˜¤ëŠ˜ì˜ ìš´ì„¸ (ë¬´ë£Œ) - /api/today í˜¸ì¶œ
// ----------------------------------------------------------------------
document.getElementById('todayBtn').addEventListener('click', async () => {
    const birthInfo = getBirthInfo();
    const resultsArea = document.getElementById('results');
    resultsArea.innerHTML = '<div style="text-align:center; padding:20px;">ê³„ì‚° ì¤‘...</div>';
    
    // ë¬´ë£Œ API í˜¸ì¶œ
    const response = await fetch('/api/today', {
        method: 'POST', body: JSON.stringify(birthInfo),
        headers: { 'Content-Type': 'application/json' }
    });
    
    const result = await response.json();
    resultsArea.innerHTML = result.htmlContent; // ì„œë²„ê°€ ë³´ë‚´ì¤€ ê²°ê³¼ í‘œì‹œ
});


// ----------------------------------------------------------------------
// 2. í•œ ë‹¬ ì¶”ì²œ (ìœ ë£Œ) - /api/month í˜¸ì¶œ (í† í° ê¸°ë°˜)
// ----------------------------------------------------------------------
document.getElementById('monthTopBtn').addEventListener('click', async () => {
    const birthInfo = getBirthInfo();
    const resultsArea = document.getElementById('results');
    const email = document.getElementById('emailInput').value;
    const token = localStorage.getItem('saju_user_token'); // ì €ì¥ëœ ìë™ ì¸ì¦ ID í™•ì¸

    if (!email) {
        alert("ğŸ”’ ìœ ë£Œ ì„œë¹„ìŠ¤ ì´ìš©ì„ ìœ„í•´ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
        return;
    }
    resultsArea.innerHTML = '<div style="text-align:center; padding:20px;">ì¸ì¦ í™•ì¸ ë° ê³„ì‚° ì¤‘...</div>';

    let requestBody = { ...birthInfo, email: email };
    
    // 1. ì €ì¥ëœ í† í°ì´ ìˆë‹¤ë©´ í† í°ì„ ì‚¬ìš© (ìë™ ì¸ì¦)
    if (token) {
        requestBody.token = token;
    } else {
        // 2. í† í°ì´ ì—†ë‹¤ë©´ (ìµœì´ˆ ì ‘ì†), ì¸ì¦ ì½”ë“œë¥¼ ë¬¼ì–´ë´…ë‹ˆë‹¤.
        const authCode = prompt("ğŸ”’ ìœ ë£Œ ê²°ì œ ì‹œ ë°›ì€ ì¸ì¦ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
        if (!authCode) { resultsArea.innerHTML = ''; return; } // ì·¨ì†Œ ì‹œ ì¢…ë£Œ
        requestBody.code = authCode;
    }

    // ì„œë²„ í˜¸ì¶œ
    const response = await fetch('/api/month', {
        method: 'POST', body: JSON.stringify(requestBody),
        headers: { 'Content-Type': 'application/json' }
    });

    if (response.status === 401) {
        localStorage.removeItem('saju_user_token'); // ì‹¤íŒ¨ ì‹œ í† í° ì‚­ì œ
        alert("ğŸš¨ ì¸ì¦ ì‹¤íŒ¨: ì…ë ¥ ì •ë³´ê°€ ì˜ëª»ë˜ì—ˆê±°ë‚˜ ìœ ë£Œ í† í°ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        resultsArea.innerHTML = ''; 
        return;
    }

    const result = await response.json();

    // ì„œë²„ê°€ ìƒˆ í† í°ì„ ì£¼ë©´ ì €ì¥í•©ë‹ˆë‹¤. (ìë™ ì¸ì¦ ID ì—…ë°ì´íŠ¸)
    if (result.access_token) {
        localStorage.setItem('saju_user_token', result.access_token);
    }
    
    resultsArea.innerHTML = result.htmlContent; // ê²°ê³¼ í‘œì‹œ
});
</script>
</body>
</html>